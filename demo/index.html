<!DOCTYPE html>
<html lang="en">

<head>
    <base href="/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WEBx, the blazing fast web tool">
    <title>Webx v1 Demo</title>
    <link rel="preconnect" href="https://jsonplaceholder.typicode.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" as="style" href="/assets/app.css" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="preload" as="style" href="/assets/modal.css" onload="this.onload=null;this.rel='stylesheet'" />
    <style>   
        :root {
            --modal-width: 400px;
            --modal-border-radius: 8px;
            --modal-backdrop-color: steelblue;
        }     
        .logo {
            background-color: #ccc;
            color: #333;
            border-radius: 13px;
        }
        .version  {
            font-size: .75em;
            background-color: #f1f1f1;
            padding: 1px 3px;
            border-radius: 5px;
        }
        .blog-posts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 20px;
            row-gap: 20px;
        }

        .blog-page img {
            margin-top: 20px;
            object-fit: cover;
            width: 100%;
            height: 200px;
        }

        .home-page {
            display: grid;
            place-items: center;
            padding: 30px auto;
        }

        .blog-page {
            border-color: steelblue;
        }

        .about-page {
            border-color: orange;
        }

        .settings-page {
            border-color: red;
        }
        .active--blue {
            background-color: steelblue;
            color: white;
        }
        .active--orange {
            background-color: orange;
            color: white;
        }
        .active--red {
            background-color: red;
            color: white;
        }
        .relative {
            position: relative;
        }
        #renderTime {
            font-size: .8em;
            position: absolute;
            top: 16px;
            right: 20px;
            color: #666;
        }
    </style>
    <script src="templates/about.js" async></script>
    <script src="templates/blog.js" async></script>
    <script src="templates/settings.js" async></script>
    <script src="templates/blogpost.js" async></script>

</head>

<body>
    <div class="appshell">
        <header class="relative">
            <nav>
                <a href="/" data-route="home">üö• WEBx <span class="version">v1</span></a>
                <a href="/blog" data-route="blog">Blog</a>
                <!-- Uses the anchor-plugin for routing -->
                <a href="/about" data-route="about">About</a>
                <a href="/settings" data-route="settings">Settings</a>             
            </nav>
            <span id="renderTime">rendered @</span>
        </header>
        <div id="app"></div>
        <footer onclick="alert(JSON.stringify(window.app.getState()));">Made with ‚ù§Ô∏è love by the üö• WEBx team!</footer>
    </div>
    <script src="/webx1.umd.js"></script>
    <script src="scripts/plugins.js"></script>
    <script>
        const app = window.webx1({
            debug: true,
            init: async () => {
                try {
                    const res = await fetch('https://jsonplaceholder.typicode.com/posts/');
                    const posts = await res.json();

                    return { posts: posts.slice(0, 6), message: 'üö• WEBx rocks!' }
                } catch (e) {
                    return { postsError: 'Unable to fetch posts', message: 'Rocks' }
                }
            },
            routeInit: (route, state) => {
                // runs before every route is rendered..
                // dyanmic views are not mounted yet!
                let renderTimeEl = document.querySelector('#renderTime');
                const date = new Date();
                const time = date.toLocaleTimeString("en-US", {
                    hour: "numeric",
                    minute: "2-digit",
                    second: "2-digit"
                });
                renderTimeEl.textContent = `rendered @ ${time}`;


            },
            routes: {
                '/': {
                    view: ({ message }) => `<div class="page home-page"><h1></h1></div>`,
                    init: ({ message }, ctx) => {
                        // type plugin call
                        ctx.typer.typeIt(document.querySelector('h1'), message, 50);
                    },
                    name: 'home',                    
                    meta: { title: 'Home' },
                    activeClass: '__none__'
                },
                '/blog': {
                    view: (state) => blog(state),
                    name: 'blog',
                    meta: { title: 'Blog' },
                    activeClass: 'active--blue'
                },
                '/blog/:id': {
                    view: (state) => blogpost(state),
                    init: (state, ctx, el) => {
                        let btn = el.querySelector('.author button');
                        btn.addEventListener('click', () => {

                            fetch(`https://jsonplaceholder.typicode.com/users/${state.params.id}`)
                                .then(res => res.json())
                                .then(data => {
                                    ctx.modal.show(ctx.template.render('author', data), (modalEl, {close}) => {
                                        modalEl.querySelector('.ok').addEventListener('click', close)
                                    })
                                })
                        })
                    },
                    name: 'post',
                    root: 'blog',
                    meta: { title: 'Post' },
                    activeClass: 'active--blue'
                },
                '/about': {
                    view: () => about,
                    name: 'about',
                    meta: { title: 'About Us' },
                    activeClass: 'active--orange',
                    init: async (state, ctx, el) => {
                        ctx.template.ready('lorem', (tmpl) => {
                            el.querySelector('#lorem').innerHTML = ['blue', 'orange','red'].map(x => tmpl({color: x})).join('');
                        })
                    }
                },
                '/settings': {
                    view: () => settings,
                    init: (state, { setState }, el) => {
                        let $inp = el.querySelector('input[name="message"]');
                        $inp.value = state['message'];

                        $inp.addEventListener('change', function (e) {
                            e.preventDefault();
                            setState('message', e.target.value);
                        });
                    },
                    name: 'settings',
                    meta: { title: 'Settings' },
                    activeClass: 'active--red'
                }
            },
            metaTitlePrepend: 'WEBx üö• ',
            plugins: [
                [window.webx1NavPlugin, { scope: 'body', activeClassName: 'active' }],
                [window.webx1TyperPlugin, { speed: 50 } ],
                [window.webx1TemplaterPlugin, {
                    installed: async (name, api) => {
                        await api.registerFromUrl('lorem', 'partials/lorem.html');
                        api.register('author', `<div class="author-info">
                            <p><%=page.name%>, <%=page.address.city%></p>
                            <button class="button ok">OK</button>
                        </div>`);
                    }
                }],
                [window.webx1ModalPlugin, {}]
            ],
            computed: {
                'sid': [() => new Date().getTime()],
                'currentPost': [(state, route) => {
                    if (route && route.name === 'post') {
                        let post = state.posts.filter(x => x.id === parseInt(route.params.id))[0];
                        return post;
                    }
    
                    return null;
                }]
            },
            node: document.getElementById('app')
        })
        .then(app => {
            window.app = app;
            /*                         
            app.listen(function (type, ...rest) {
                console.log('state change', type, rest)
            });
            */
        })
    </script>

</body>

</html>