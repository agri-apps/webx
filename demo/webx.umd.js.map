{"version":3,"file":"webx.umd.js","sources":["../src/utils/rules.js","../src/index.js"],"sourcesContent":["const rules = {\n    isString: (o) => {\n      return o !== null && typeof o === \"string\";\n    },\n    isEmptyObject: (o) => {\n      var name;\n      for (name in o) {\n        if (o.hasOwnProperty(name)) return false;\n      }\n      return true;\n    },\n    isFunc: (o) => {\n      return typeof o === \"function\";\n    },\n    isAsyncFunc: (fn) => {\n      return rules.isFunc(fn) && fn.constructor.name === \"AsyncFunction\";\n    },\n    isNode: (o) => {\n      return typeof Node === \"object\"\n        ? o instanceof Node\n        : o &&\n            typeof o === \"object\" &&\n            typeof o.nodeType === \"number\" &&\n            typeof o.nodeName === \"string\";\n    },\n    isElement: (o) => {\n      return typeof HTMLElement === \"object\"\n        ? o instanceof HTMLElement //DOM2\n        : o &&\n            typeof o === \"object\" &&\n            o !== null &&\n            o.nodeType === 1 &&\n            typeof o.nodeName === \"string\";\n    },\n  };\n\n  export default rules;","import rules from \"./utils/rules\";\n\nconst defaultOptions = {\n  global: \"$\",\n  appName: \"App\",\n  routes: {},\n};\n\nif (typeof window !== \"undefined\") {\n  window.appRules = rules;\n}\n\nexport default createApp = async (options) => {\n  let opts = Object.assign({}, defaultOptions, options);\n\n  let cache = {\n    routes: {\n      \"/\": () => ({\n        view: `<div>Webx Rocks!</div>`,\n      }),\n    },\n  };\n\n  // routes\n  if (!rules.isEmptyObject(opts.routes)) {\n    // prevalidate routes\n    let routeErrors = {};\n    for (var x in opts.routes) {\n      if (opts.routes.hasOwnProperty(x)) {\n        if (!opts.routes[x].view) {\n          routeErrors[x] = [`A view property is required for route \"${x}\"`];\n        }\n      }\n    }\n    if (Object.keys(routeErrors).length) {\n      throw new Error(\"Invalid route configuration\", routeErrors);\n    }\n    cache.routes = opts.routes;\n  }\n\n  const app = {\n    el: document.body,\n    _currentPath: null,\n    _currentRoute: null,\n    _state: {},\n    _listeners: [],\n    routes: { ...cache.routes },\n    ok: true,\n    getState: () => ({ ...app._state }),\n    setState: (key, value) => {\n      let oldState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      app._state[key] = value;\n      let newState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      // change listeners\n      app._listeners.forEach((listener) => {\n        listener(\"stateChange\", newState, oldState, key, value);\n      });\n      let evt = new CustomEvent(\"appStateChanged\", {\n        detail: {\n          type: \"stateChange\",\n          newState,\n          oldState,\n          key: key,\n          value: value,\n        },\n      });\n      app.el.dispatchEvent(evt);\n    },\n    listen: (handler) => {\n      if (rules.isFunc(handler)) {\n        app._listeners.push(handler);\n      } else {\n        console.error(\"Listen handler must be a function\", handler);\n      }\n    },\n    refresh: () => {\n      app.navigate(app._currentPath, true);\n    },\n    renderView: async (view, state, meta) => {\n      if (!rules.isFunc(view)) {\n        throw new Error(\"renderView requires a function.\");\n      }\n\n      if (app.el.renderView && rules.isFunc(app.el.renderView)) {\n        if (rules.isAsyncFunc(app.el.renderView)) {\n          try {\n            await app.el.renderView(view, state, meta);\n          } catch (err) {\n            console.error(\"render async view error\", err);\n          }\n        } else {\n          app.el.renderView(view, state, meta);\n        }\n\n        return;\n      }\n\n      console.log(\"async view\", rules.isAsyncFunc(view));\n\n      if (rules.isAsyncFunc(view)) {\n        try {\n          app.el.innerHTML = await view(state);\n        } catch (err) {\n          console.error(\"Render view errror\", err);\n        }\n      } else {\n        app.el.innerHTML = view(state);\n      }\n\n      if (meta) {\n        document.title = meta.title;\n      }\n    },\n    navigate: async (pathName, force) => {\n      // don't fire same route unless forced\n      if (!force && app._currentPath && app._currentPath === pathName) {\n        return false;\n      }\n      const prevPath = app._currentPath;\n      app._currentPath = pathName;\n      let query = {};\n      let params = {};\n\n      const proxy = {\n        setState: app.setState,\n        getState: app.getState,\n        refresh: app.refresh,\n      };\n\n      const setRoute = async (path, xtra = {}) => {       \n\n        console.log(\"routes\", path, routes);\n        let route = routes[path];        \n\n        if (!route) {\n          route = routes[\"/notfound\"] || {\n            view: () => `<div class=\"page\">404 Not Found</div>`,\n          };\n        }\n\n        app._currentRoute = path;\n\n        query = location.search\n          .slice(1)\n          .split(\"&\")\n          .reduce((prev, curr) => {\n            let t = curr.split(\"=\");\n            prev[t[0]] = decodeURIComponent(t[1] || \"\");\n            return prev;\n          }, {});\n        let state = { ...app.getState(), ...xtra, query, path };\n\n        // Render view\n        try {\n          await app.renderView(route.view, state, route.meta);\n          console.log(\"view rendered\", app.el.innerHTML);\n        } catch (err) {\n          console.error(err);\n        }\n\n        // Initialize route\n        if (rules.isFunc(route.init)) {\n          if (rules.isAsyncFunc(route.init)) {\n            await route.init(state, proxy, app.el);\n          } else {\n            route.init(state, proxy, app.el);\n          }\n        }\n\n        const { params = {} } = xtra;\n\n        app._listeners.forEach((listener) => {\n          listener(\"pageChange\", {\n            from: prevPath,\n            to: app._currentRoute,\n            params,\n            query,\n          });\n        });\n      };\n\n      const { routes } = app;\n\n      // Unmount current route, if any\n      if (app._currentRoute) {\n        let route = app.routes[app._currentRoute];\n        if (route && rules.isFunc(route.unmount)) {\n          route.unmount(proxy);\n        }\n      }\n\n      // exact match\n      if (routes[pathName]) {\n        app._currentRoute = pathName;\n        setRoute(pathName);\n        return { path: pathName, route: pathName, query, params };\n      }\n\n      // param route w/fuzzy match logic\n      let tokens = pathName.split(\"/\").slice(1);\n      let found = Object.keys(routes).filter((x) => {\n        return (\n          x.indexOf(`/${tokens[0]}`) !== -1 &&\n          x.split(\"/\").slice(1).length === tokens.length\n        );\n      })[0];\n\n      if (found) {        \n        found\n          .split(\"/\")\n          .slice(2)\n          .forEach((n, x) => {\n            params[n.slice(1)] = tokens[x + 1];\n          });\n        setRoute(found, { params });\n        return { path: pathName, route: found, query, params };\n      }\n      // Not found\n      app._currentRoute = \"notfound\";\n      setRoute(\"/notfound\");\n      return { path: pathName, route: undefined, query, params };\n    },\n  };\n\n  return {\n    mount: async (el) => {\n      try {\n        if (rules.isString(el)) {\n          app.el = document.querySelector(el);\n          if (!app.el) {\n            throw new Error(\n              `Invalid mount target: ${el}. Missing from the DOM.`\n            );\n          }\n        } else {\n          if (!rules.isNode(el) || !rules.isElement(el)) {\n            throw new Error(\"Invalid DOM object for mount.\");\n          }\n          app.el = el;\n        }\n\n        if (rules.isFunc(opts.init)) {\n          opts.debug &&\n            console.log(\n              \"App state from function. Is async: \",\n              rules.isAsyncFunc(opts.init) ? \"yes\" : \"no\"\n            );\n          // try to just invoke function;\n          app._state = rules.isAsyncFunc(opts.init)\n            ? await opts.init()\n            : opts.init();\n          console.log(\"func app state\", app._state);\n        } else {\n          app._state = opts.init || {};\n        }\n\n        if (opts.debug) {\n          console.log(\"Initial app state\", app._state);\n        }\n\n        window.onpopstate = async () => {\n          await app.navigate(window.location.pathname);\n        };\n\n        window[opts.global] = window[opts.global] || {};\n\n        window[opts.global].navigate = async (pathName) => {\n          window.history.pushState(\n            {},\n            pathName,\n            window.location.origin + pathName\n          );\n          await app.navigate(pathName);\n        };\n\n        await app.navigate(window.location.pathname);\n\n        return app;\n      } catch (e) {\n        return { ok: false, error: e };\n      }\n    },\n  };\n};\n"],"names":["rules","isString","o","isEmptyObject","name","hasOwnProperty","isFunc","isAsyncFunc","fn","constructor","isNode","Node","nodeType","nodeName","isElement","HTMLElement","_catch","body","recover","result","e","then","defaultOptions","global","appName","routes","window","appRules","createApp","options","opts","Object","assign","cache","/","view","routeErrors","x","keys","length","Error","app","el","document","_currentPath","_currentRoute","_state","_listeners","ok","getState","setState","key","value","oldState","freeze","JSON","parse","stringify","newState","forEach","listener","evt","CustomEvent","detail","type","dispatchEvent","listen","handler","push","console","error","refresh","navigate","renderView","state","meta","title","log","innerHTML","err","pathName","force","prevPath","query","params","proxy","setRoute","path","xtra","from","to","route","init","location","search","slice","split","reduce","prev","curr","t","decodeURIComponent","unmount","tokens","found","filter","indexOf","n","undefined","mount","debug","onpopstate","pathname","history","pushState","origin","querySelector"],"mappings":"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"}