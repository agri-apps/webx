!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).webx1=t()}(this,function(){function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var t={isString:function(e){return null!==e&&"string"==typeof e},isEmptyObject:function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},isFunc:function(e){return"function"==typeof e},isAsyncFunc:function(e){return t.isFunc(e)&&"AsyncFunction"===e.constructor.name},isNode:function(e){return"object"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},isElement:function(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}};function n(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var r={global:"$",appName:"App",routes:{}};return"undefined"!=typeof window&&(window.appRules=t),function(o){try{var i=Object.assign({},r,o),u={routes:{"/":function(){return{view:"<div>Webx Rocks!</div>"}}}};if(!t.isEmptyObject(i.routes)){var c={};for(var s in i.routes)i.routes.hasOwnProperty(s)&&(i.routes[s].view||(c[s]=['A view property is required for route "'+s+'"']));if(Object.keys(c).length)throw new Error("Invalid route configuration",c);u.routes=i.routes}var a={el:document.body,_currentPath:null,_currentRoute:null,_state:{},_listeners:[],routes:e({},u.routes),ok:!0,getState:function(){var t=[].slice.call(arguments);return t.length?a._state[t[0]]:e({},a._state)},setState:function(e,t){var n=Object.freeze(JSON.parse(JSON.stringify(a._state)));a._state[e]=t;var r=Object.freeze(JSON.parse(JSON.stringify(a._state)));a._listeners.forEach(function(o){o("stateChange",r,n,e,t)})},replaceState:function(e){var t=Object.freeze(JSON.parse(JSON.stringify(a._state)));a._state=e,a._listeners.forEach(function(n){n("stateChange",e,t,"*",e)})},dispatch:function(e){var t=arguments;a._listeners.forEach(function(n){n.apply(null,[e].concat([].slice.call(t,1)))})},listen:function(e){t.isFunc(e)?a._listeners.push(e):console.error("Listen handler must be a function",e)},refresh:function(){a.navigate(a._currentPath,!0)},renderView:function(e,r,o){try{var i,u=function(u){if(i)return u;function c(){o&&(document.title=o.title)}var s=function(){if(t.isAsyncFunc(e)){var o=n(function(){return Promise.resolve(e(r)).then(function(e){a.el.innerHTML=e})},function(e){console.error("Render view errror",e)});if(o&&o.then)return o.then(function(){})}else a.el.innerHTML=e(r)}();return s&&s.then?s.then(c):c()};if(!t.isFunc(e))throw new Error("renderView requires a function.");var c=function(){if(a.el.renderView&&t.isFunc(a.el.renderView)){var u=function(){i=1},c=function(){if(t.isAsyncFunc(a.el.renderView)){var i=n(function(){return Promise.resolve(a.el.renderView(e,r,o)).then(function(){})},function(e){console.error("render async view error",e)});if(i&&i.then)return i.then(function(){})}else a.el.renderView(e,r,o)}();return c&&c.then?c.then(u):u()}}();return Promise.resolve(c&&c.then?c.then(u):u(c))}catch(e){return Promise.reject(e)}},navigate:function(r,o){try{if(!o&&a._currentPath&&a._currentPath===r)return Promise.resolve(!1);var i=a._currentPath;a._currentPath=r;var u={},c={},s={setState:a.setState,getState:a.getState,dispatch:a.dispatch,refresh:a.refresh},f=function(r,o){void 0===o&&(o={});try{var c=function(){function e(){var e=o.params,t=void 0===e?{}:e;a._listeners.forEach(function(e){e("pageChange",{from:i,to:a._currentRoute,params:t,query:u})})}var n=function(){if(t.isFunc(f.init)){var e=function(){if(t.isAsyncFunc(f.init))return Promise.resolve(f.init(h,s,a.el)).then(function(){});f.init(h,s,a.el)}();if(e&&e.then)return e.then(function(){})}}();return n&&n.then?n.then(e):e()},f=l[r];f||(f=l["/notfound"]||{view:function(){return'<div class="page">404 Not Found</div>'}}),a._currentRoute=r,u=location.search.slice(1).split("&").reduce(function(e,t){var n=t.split("=");return e[n[0]]=decodeURIComponent(n[1]||""),e},{});var h=e({},a.getState(),o,{query:u,path:r}),v=n(function(){return Promise.resolve(a.renderView(f.view,h,f.meta)).then(function(){})},function(e){console.error(e)});return Promise.resolve(v&&v.then?v.then(c):c())}catch(e){return Promise.reject(e)}},l=a.routes;if(a._currentRoute){var h=a.routes[a._currentRoute];h&&t.isFunc(h.unmount)&&h.unmount(s)}if(l[r])return a._currentRoute=r,f(r),Promise.resolve({path:r,route:r,query:u,params:c});var v=r.split("/").slice(1),p=Object.keys(l).filter(function(e){return-1!==e.indexOf("/"+v[0])&&e.split("/").slice(1).length===v.length})[0];return p?(p.split("/").slice(2).forEach(function(e,t){c[e.slice(1)]=v[t+1]}),f(p,{params:c}),Promise.resolve({path:r,route:p,query:u,params:c})):(a._currentRoute="notfound",f("/notfound"),Promise.resolve({path:r,route:void 0,query:u,params:c}))}catch(e){return Promise.reject(e)}}};return Promise.resolve({mount:function(e){try{return Promise.resolve(n(function(){function n(){return i.debug&&console.log("Initial app state",a._state),window.onpopstate=function(){try{return Promise.resolve(a.navigate(window.location.pathname)).then(function(){})}catch(e){return Promise.reject(e)}},window[i.global]=window[i.global]||{},window[i.global].navigate=function(e){try{return window.history.pushState({},e,window.location.origin+e),Promise.resolve(a.navigate(e)).then(function(){})}catch(e){return Promise.reject(e)}},Promise.resolve(a.navigate(window.location.pathname)).then(function(){return a})}if(t.isString(e)){if(a.el=document.querySelector(e),!a.el)throw new Error("Invalid mount target: "+e+". Missing from the DOM.")}else{if(!t.isNode(e)||!t.isElement(e))throw new Error("Invalid DOM object for mount.");a.el=e}var r=function(){if(t.isFunc(i.init)){var e=function(e){a._state=e};return i.debug&&console.log("App state from function. Is async: ",t.isAsyncFunc(i.init)?"yes":"no"),t.isAsyncFunc(i.init)?Promise.resolve(i.init()).then(e):e(i.init())}a._state=i.init||{}}();return r&&r.then?r.then(n):n()},function(e){return{ok:!1,error:e}}))}catch(e){return Promise.reject(e)}}})}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=webx1.umd.js.map
