!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).webx1=n()}(this,function(){function e(){return(e=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}var n={isArray:function(e){return Array.isArray(e)},isString:function(e){return null!==e&&"string"==typeof e},isEmptyObject:function(e){var n;for(n in e)if(e.hasOwnProperty(n))return!1;return!0},isFunc:function(e){return"function"==typeof e},isAsyncFunc:function(e){return n.isFunc(e)&&"AsyncFunction"===e.constructor.name},isNode:function(e){return"object"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},isElement:function(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}};function t(e,n){try{var t=e()}catch(e){return n(e)}return t&&t.then?t.then(void 0,n):t}var r={global:"$",appName:"App",metaTitlePrepend:"",routes:{},notFoundRouteName:"notfound",notFoundUrl:"/notfound"};return function(o){try{var i,u=Object.assign({},r,o),s={views:{},_routes:{},routes:(i={"/":function(){return{view:"<div>Webx Rocks!</div>"}}},i["/notfound"]=function(){return{view:"<div>404 Not Found!</div>"}},i["/error"]=function(){return{view:"<div>An error has occurred!</div>"}},i)};s.routes=Object.assign({},s.routes,u.routes);var c=function(e){try{u.debug&&console.log("Resolving route",e,n.isString(e));var t=e;if(n.isString(e)){if(s._routes[e])return u.debug&&console.log(e+" resolved from cache."),Promise.resolve(s._routes[e]);t=s.routes[e]}return n.isFunc(t)?Promise.resolve(t()).then(function(n){return n?(s._routes[e]=n.default?n.default:n,s._routes[e]):null}):(s._routes[e]=t,Promise.resolve(t))}catch(e){return Promise.reject(e)}},a=function(e){var n={setState:e.setState,getState:e.getState,dispatch:e.dispatch,listen:e.listen,refresh:e.refresh};return Object.keys(e._plugins).reduce(function(n,t){var r=e._plugins[t];if(r.api){var o=r.namespace?r.namespace:r.name;n[o]=n[o]?Object.assign(n[o],r.api):r.api}return n},n)},l={el:document.body,_currentPath:null,_currentRoute:null,_state:{},_listeners:[],_plugins:{},routes:e({},s.routes),ok:!0,plugin:function(e,t){if(void 0===t&&(t={}),!e.name)throw new Error("A plugin must have a name property.");if(!e.install||!n.isFunc(e.install))throw new Error("A plugin must define an install method.");if(l._plugins[e.name])throw new Error('A plugin with the name: "'+e.name+' is already registered."');l._plugins[e.name]=e;try{var r=e.install(l,t);r&&(l._plugins[e.name].api=r,e.global&&(window[e.global]?window[e.global]=Object.assign(window[e.global],r):window[e.global]=r),l.ctx=a(l)),t.installed&&n.isFunc(t.installed)&&t.installed()}catch(r){console.error('Plugin "'+e.name+'" failed to install.',r),t.onError&&n.isFunc(t.onError)&&t.onError(r),delete l._plugins[e.name]}},getState:function(){var n=[].slice.call(arguments);return n.length?l._state[n[0]]:e({},l._state)},setState:function(e,n){var t=Object.freeze(JSON.parse(JSON.stringify(l._state)));l._state[e]=n;var r=Object.freeze(JSON.parse(JSON.stringify(l._state)));l._listeners.forEach(function(o){o("stateChange",r,t,e,n)})},replaceState:function(e){var n=Object.freeze(JSON.parse(JSON.stringify(l._state)));l._state=e,l._listeners.forEach(function(t){t("stateChange",e,n,"*",e)})},dispatch:function(e){var n=arguments;l._listeners.forEach(function(t){t.apply(null,[e].concat([].slice.call(n,1)))})},listen:function(e){if(n.isFunc(e))return l._listeners.push(e),function(){var n=l._listeners.indexOf(e);-1!==n&&l._listeners.splice(n,1)};console.error("Listen handler must be a function",e)},refresh:function(){l.navigate(l._currentPath,!0,!0).then(function(){return l.dispatch("refreshed",l._currentPath)})},renderView:function(e,r,o){try{var i,s=function(n){if(i)return n;function s(){o&&(document.title=""+u.metaTitlePrepend+o.title),l.dispatch("view-rendered",{detail:{view:e,meta:o}})}var c=t(function(){return Promise.resolve(e(r)).then(function(e){l.el.innerHTML=e})},function(n){console.error("Render view errror",n),l.dispatch("view-render-failed",{detail:e,error:n})});return c&&c.then?c.then(s):s()},c=l.el.renderView&&n.isFunc(l.el.renderView);if(!n.isFunc(e))return c?l.el.renderView(e,r,o):l.el.innerHTML=""+e,l.dispatch("view-rendered",{detail:{view:e,meta:o}}),Promise.resolve();if(!n.isFunc(e))throw new Error("renderView requires a function.");var a=function(){if(c){var n=function(){i=1},u=t(function(){return Promise.resolve(l.el.renderView(e,r,o)).then(function(){})},function(n){console.error("render async view error",n),l.dispatch("view-render-failed",{detail:e,error:n})});return u&&u.then?u.then(n):n()}}();return Promise.resolve(a&&a.then?a.then(s):s(a))}catch(e){return Promise.reject(e)}},initRoute:function(e,t){try{var r=a(l);return Promise.resolve(c(e)).then(function(e){var o=function(){if(n.isFunc(e.init))return Promise.resolve(e.init(t,r,l.el)).then(function(){})}();if(o&&o.then)return o.then(function(){})})}catch(e){return Promise.reject(e)}},unmountRoute:function(e){try{return Promise.resolve(c(e)).then(function(e){e&&n.isFunc(e.unmount)&&e.unmount(a(l))})}catch(e){return Promise.reject(e)}},routeInit:function(e,t){try{return Promise.resolve(c(e)).then(function(e){var r=function(){if(u.routeInit&&n.isFunc(u.routeInit))return Promise.resolve(u.routeInit(e,t)).then(function(){})}();if(r&&r.then)return r.then(function(){})})}catch(e){return Promise.reject(e)}},navigate:function(r,o,i){try{var a=function(){return Promise.resolve(c(r)).then(function(e){function n(e){var n;function t(e){return n?e:(l._currentRoute=u.notFoundRouteName,Promise.resolve(v(u.notFoundUrl)).then(function(){return{path:r,route:void 0,query:d,params:h}}))}var o=r.split("/").slice(1),i=Object.keys(s.routes).filter(function(e){return-1!==e.indexOf("/"+o[0])&&e.split("/").slice(1).length===o.length})[0],c=function(){if(i)return i.split("/").slice(2).forEach(function(e,n){h[e.slice(1)]=o[n+1]}),Promise.resolve(v(i,{params:h})).then(function(){return n=1,{path:r,route:i,query:d,params:h}})}();return c&&c.then?c.then(t):t(c)}var t=function(){if(e)return l._currentRoute=r,Promise.resolve(v(r)).then(function(){return{path:r,route:r,query:d,params:h}})}();return t&&t.then?t.then(n):n()})};if(!o&&l._currentPath&&l._currentPath===r)return Promise.resolve(!1);var f=l._currentPath;l._currentPath=r;var d={},h={},v=function(r,o){void 0===o&&(o={});try{return Promise.resolve(c(r)).then(function(u){function s(){function e(){function e(){var e=o.params,n=void 0===e?{}:e;i||l._listeners.forEach(function(e){e("pageChange",{from:f,to:l._currentRoute,params:n,query:d})})}var n=t(function(){return Promise.resolve(l.initRoute(u,c)).then(function(){})},function(e){console.error('Init route for "'+(u.name?u.name:r)+'" failed',e)});return n&&n.then?n.then(e):e()}var n=t(function(){return Promise.resolve(l.renderView(u.view,c,u.meta)).then(function(){})},function(e){console.error("Render view failed",e)});return n&&n.then?n.then(e):e()}null===u&&(u=routes["/notfound"]||{view:function(){return'<div class="page">404 Not Found</div>'}}),l._currentRoute=r,d=location.search.slice(1).split("&").reduce(function(e,n){var t=n.split("=");return e[t[0]]=decodeURIComponent(t[1]||""),e},{});var c=e({},l.getState(),o,{query:d,path:r}),a=function(){if(!i){var r=t(function(){return Promise.resolve(l.routeInit(u,c)).then(function(t){t&&!n.isEmptyObject(t)&&(c=e({},c,{routeState:t}))})},function(e){console.error("Pre-render failed:",e)});if(r&&r.then)return r.then(function(){})}}();return a&&a.then?a.then(s):s()})}catch(e){return Promise.reject(e)}},m=function(){if(!i){var e=function(){if(l._currentRoute){var e=l.unmountRoute;return Promise.resolve(c(l._currentRoute)).then(function(n){e.call(l,n)})}}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(m&&m.then?m.then(a):a())}catch(e){return Promise.reject(e)}},boot:function(){return Promise.resolve()}},f=function(e){try{return Promise.resolve(t(function(){function t(){return u.debug&&console.log("Initial app state",l._state),window.onpopstate=function(){try{return Promise.resolve(l.navigate(window.location.pathname)).then(function(){})}catch(e){return Promise.reject(e)}},l.global=u.global,window[u.global]=window[u.global]||{},window[u.global].navigate=function(e){try{return window.history.pushState({},e,window.location.origin+e),Promise.resolve(l.navigate(e)).then(function(){})}catch(e){return Promise.reject(e)}},window[u.global].dispatch=l.dispatch.bind(l),Promise.resolve(l.boot()).then(function(){return Promise.resolve(l.navigate(window.location.pathname)).then(function(){return l})})}if(n.isString(e)){if(l.el=document.querySelector(e),!l.el)throw new Error("Invalid mount target: "+e+". Missing from the DOM.")}else{if(!n.isNode(e)||!n.isElement(e))throw new Error("Invalid DOM object for mount.");l.el=e}var r=function(){if(n.isFunc(u.init))return Promise.resolve(u.init()).then(function(e){l._state=e});l._state=u.init||{}}();return r&&r.then?r.then(t):t()},function(e){return{ok:!1,error:e}}))}catch(e){return Promise.reject(e)}};return l.el=u.node||document.body,u.plugins&&n.isArray(u.plugins)&&u.plugins.forEach(function(e){l.plugin(e[0],e.length>1?e[1]:{})}),l.ctx=a(l),u.node&&(n.isElement(u.node)||n.isNode(u.node))?f(u.node):f(document.body)}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=webx1.umd.js.map
