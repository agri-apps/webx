!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).webx1=t()}(this,function(){function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var t={isArray:function(e){return Array.isArray(e)},isString:function(e){return null!==e&&"string"==typeof e},isEmptyObject:function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},isFunc:function(e){return"function"==typeof e},isAsyncFunc:function(e){return t.isFunc(e)&&"AsyncFunction"===e.constructor.name},isNode:function(e){return"object"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},isElement:function(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&null!==e&&1===e.nodeType&&"string"==typeof e.nodeName}};function n(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var r={debug:!1,global:"$",appName:"App",metaTitlePrepend:"",routes:{},notFoundRouteName:"notfound",notFoundUrl:"/notfound"};return function(o){try{var i,u=Object.assign({},r,o),c={views:{},_routes:{},_computed:{},_waiting:{plugins:[]},routes:(i={"/":function(){return{view:"<div>Webx Rocks!</div>"}}},i["/notfound"]=function(){return{view:"<div>404 Not Found!</div>"}},i["/error"]=function(){return{view:"<div>An error has occurred!</div>"}},i)};c.routes=Object.assign({},c.routes,u.routes);var s=function(e){try{u.debug&&console.log("[debug] Resolving route",e,t.isString(e));var n=e;if(t.isString(e)){if(c._routes[e])return u.debug&&console.log("[debug] "+e+" resolved from cache."),Promise.resolve(c._routes[e]);n=c.routes[e]}return t.isFunc(n)?Promise.resolve(n()).then(function(t){return t?(c._routes[e]=t.default?t.default:t,c._routes[e]):null}):(c._routes[e]=n,Promise.resolve(n))}catch(e){return Promise.reject(e)}},a=function(e){var t={setState:e.setState,getState:e.getState,dispatch:e.dispatch,listen:e.listen,refresh:e.refresh,computed:function(t){var n=e._computed[t];return n?n[0](e.getState()):null}};return Object.keys(e._plugins).reduce(function(t,n){var r=e._plugins[n];if(r.api){var o=r.namespace?r.namespace:r.name;t[o]=t[o]?Object.assign(t[o],r.api):r.api}return t},t)},l={debug:u.debug,el:document.body,_currentPath:null,_currentRoute:null,_state:{},_listeners:[],_plugins:{},_computed:{},routes:e({},c.routes),route:null,ok:!0,plugin:function(e,r){void 0===r&&(r={});try{if(!e.name)throw new Error("A plugin must have a name property.");if(!e.install||!t.isFunc(e.install))throw new Error("A plugin must define an install method.");if(l._plugins[e.name])throw new Error('A plugin with the name: "'+e.name+' is already registered."');l._plugins[e.name]=e;var o=n(function(){return Promise.resolve(e.install(l,r)).then(function(n){u.debug&&console.log('[debug] Plugin "'+e.name+'" installed.'),n&&(l._plugins[e.name].api=n,e.global&&(window[e.global]?window[e.global]=Object.assign(window[e.global],n):window[e.global]=n),l.ctx=a(l));var o=function(){if(r.installed&&t.isFunc(r.installed))return Promise.resolve(r.installed(e.name,n)).then(function(){})}();if(o&&o.then)return o.then(function(){})})},function(n){console.error('Plugin "'+e.name+'" failed to install.',n),r.onError&&t.isFunc(r.onError)&&r.onError(n),delete l._plugins[e.name]});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},waitForPlugin:function(e,t){l.ctx&&l.ctx[e]?t(l.ctx[e],l):(c._waiting.hasOwnProperty(e)||(c._waiting[e]=[]),c._waiting[e].push(t))},getRoute:s,getState:function(){var t=[].slice.call(arguments),n=Object.keys(l._computed).reduce(function(t,n){var r=l._computed[n],o=r[0],i=r[1],u=!i||!i(e({},l._state,t),l.route);return u||c._computed[n]||(u=!0),u&&(t[n]=o(e({},l._state,t),l.route),i&&(c._computed[n]=JSON.parse(JSON.stringify(t[n])))),t},{}),r=e({},l._state,n);return t.length?r[t[0]]:r},setState:function(e,t){var n=Object.freeze(JSON.parse(JSON.stringify(l.getState())));l._state[e]=t,l._listeners.forEach(function(r){r("stateChange",l.getState(),n,e,t)})},replaceState:function(e){var t=Object.freeze(JSON.parse(JSON.stringify(l.getState())));l._state=e,l._listeners.forEach(function(n){n("stateChange",l.getState(),t,"*",e)})},computed:function(e,n,r){if(l._computed[e])throw new Error('A computed property named "'+e+'" already exits!');if(!t.isFunc(n))throw new Error("A computed property expects a function.");l._computed[e]=[n,r]},dispatch:function(e){var t=arguments;l._listeners.forEach(function(n){n.apply(null,[e].concat([].slice.call(t,1)))})},listen:function(e){if(t.isFunc(e))return l._listeners.push(e),function(){var t=l._listeners.indexOf(e);-1!==t&&l._listeners.splice(t,1)};console.error("Listen handler must be a function",e)},refresh:function(){l.navigate(l._currentPath,!0,!0).then(function(){return l.dispatch("refreshed",l._currentPath)})},renderView:function(e,r,o){try{var i,c=function(t){if(i)return t;function c(){o&&(document.title=""+u.metaTitlePrepend+o.title),l.dispatch("view-rendered",{detail:{view:e,meta:o}})}var s=n(function(){return Promise.resolve(e(r)).then(function(e){l.el.innerHTML=e})},function(t){console.error("Render view errror",t),l.dispatch("view-render-failed",{detail:e,error:t})});return s&&s.then?s.then(c):c()},s=l.el.renderView&&t.isFunc(l.el.renderView);if(l.debug&&console.log("[debug] rendering view",e,r,o),!t.isFunc(e))return s?l.el.renderView(e,r,o):l.el.innerHTML=""+e,l.dispatch("view-rendered",{detail:{view:e,meta:o}}),Promise.resolve();if(!t.isFunc(e))throw new Error("renderView requires a function.");var a=function(){if(s){var t=function(){i=1},u=n(function(){return Promise.resolve(l.el.renderView(e,r,o)).then(function(){l.dispatch("view-rendered",{detail:{view:e,meta:o}})})},function(t){console.error("render async view error",t),l.dispatch("view-render-failed",{detail:e,error:t})});return u&&u.then?u.then(t):t()}}();return Promise.resolve(a&&a.then?a.then(c):c(a))}catch(e){return Promise.reject(e)}},initRoute:function(e,n){try{var r=a(l);return Promise.resolve(s(e)).then(function(e){var o=function(){if(t.isFunc(e.init))return Promise.resolve(e.init(n,r,l.el)).then(function(){})}();if(o&&o.then)return o.then(function(){})})}catch(e){return Promise.reject(e)}},unmountRoute:function(e){try{return Promise.resolve(s(e)).then(function(e){e&&t.isFunc(e.unmount)&&e.unmount(a(l))})}catch(e){return Promise.reject(e)}},routeInit:function(n,r){try{return Promise.resolve(s(n)).then(function(o){function i(){var o=function(){if(n.viewState&&t.isFunc(n.viewState))return Promise.resolve(n.viewState(r,s)).then(function(t){c=e({},c,t)})}();return o&&o.then?o.then(function(){return c}):c}var c={},s=a(l),f=function(){if(u.routeInit&&t.isFunc(u.routeInit))return Promise.resolve(u.routeInit(o,r,s)).then(function(e){c=e||{}})}();return f&&f.then?f.then(i):i()})}catch(e){return Promise.reject(e)}},navigate:function(r,o,i){try{var f=function(){return Promise.resolve(s(r)).then(function(e){if(e)return l._currentRoute=r,Promise.resolve(p(r)).then(function(){return{path:r,route:r,query:h,params:m}});var t=r.split("/").slice(1),n=Object.keys(c.routes).filter(function(e){return-1!==e.indexOf("/"+t[0])&&e.split("/").slice(1).length===t.length})[0];return n?(n.split("/").slice(2).forEach(function(e,n){m[e.slice(1)]=t[n+1]}),Promise.resolve(p(n,{params:m})).then(function(){return{path:r,route:n,query:h,params:m}})):(l._currentRoute=u.notFoundRouteName,Promise.resolve(p(u.notFoundUrl)).then(function(){return{path:r,route:void 0,query:h,params:m}}))})};if(!o&&l._currentPath&&l._currentPath===r)return Promise.resolve(!1);var d=l._currentPath;l._currentPath=r;var h={},m={},p=function(o,u){void 0===u&&(u={});try{return Promise.resolve(s(o)).then(function(c){function s(){function e(){function e(){var e=u.params,t=void 0===e?{}:e;i||l._listeners.forEach(function(e){e("pageChange",{from:d,to:l._currentRoute,params:t,query:h})})}var t=n(function(){return Promise.resolve(l.initRoute(c,f)).then(function(){})},function(e){console.error('Init route for "'+(c.name?c.name:o)+'" failed',e)});return t&&t.then?t.then(e):e()}var t=n(function(){return Promise.resolve(l.renderView(c.view,f,c.meta)).then(function(){})},function(e){console.error("Render view failed",e)});return t&&t.then?t.then(e):e()}null===c&&(c=routes["/notfound"]||{view:function(){return'<div class="page">404 Not Found</div>'}}),l._currentRoute=o,h=location.search.slice(1).split("&").reduce(function(e,t){var n=t.split("=");return n[0]&&(e[n[0]]=decodeURIComponent(n[1]||"")),e},{}),l.route={name:c.name,match:o,path:r,meta:c.meta,query:h,params:u.params||{}};var f=e({},l.getState(),u,{query:h,path:o}),m=function(){if(i){var r=function(){if(c.viewState&&t.isFunc(c.viewState))return Promise.resolve(c.viewState(f,a(l))).then(function(t){f=e({},f,t)})}();if(r&&r.then)return r.then(function(){})}else{var o=n(function(){return Promise.resolve(l.routeInit(c,f)).then(function(n){n&&!t.isEmptyObject(n)&&(f=e({},f,n))})},function(e){console.error("Pre-render failed:",e)});if(o&&o.then)return o.then(function(){})}}();return m&&m.then?m.then(s):s()})}catch(e){return Promise.reject(e)}},v=function(){if(!i){var e=function(){if(l._currentRoute){var e=l.unmountRoute;return Promise.resolve(s(l._currentRoute)).then(function(t){e.call(l,t)})}}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(v&&v.then?v.then(f):f())}catch(e){return Promise.reject(e)}},boot:function(){return Promise.resolve()}},f=function(e){try{return Promise.resolve(n(function(){function n(){return u.debug&&console.log("[debug] Initial app state",l.getState()),l.global=u.global,window[u.global]=window[u.global]||{},window[u.global].navigate=function(e){try{return window.history.pushState({},e,window.location.origin+e),Promise.resolve(l.navigate(e)).then(function(){})}catch(e){return Promise.reject(e)}},window[u.global].dispatch=l.dispatch.bind(l),Promise.resolve(l.boot(a(l))).then(function(){return Promise.resolve(l.navigate(window.location.pathname)).then(function(){return l})})}if(t.isString(e)){if(l.el=document.querySelector(e),!l.el)throw new Error("Invalid mount target: "+e+". Missing from the DOM.")}else{if(!t.isNode(e)||!t.isElement(e))throw new Error("Invalid DOM object for mount.");l.el=e}var r=function(){if(t.isFunc(u.init))return Promise.resolve(u.init()).then(function(e){l._state=e});l._state=u.init||{}}();return r&&r.then?r.then(n):n()},function(e){return{ok:!1,error:e}}))}catch(e){return Promise.reject(e)}};return u.computed&&Object.keys(u.computed).forEach(function(e){u.debug&&console.log('[debug] Adding computed property "'+e+'".'),l.computed(e,u.computed[e][0],u.computed[e][1])}),l.el=u.node||document.body,u.plugins&&t.isArray(u.plugins)&&u.plugins.forEach(function(e){try{return Promise.resolve(l.plugin(e[0],e.length>1?e[1]:{})).then(function(){})}catch(e){return Promise.reject(e)}}),l.ctx=a(l),Object.keys(c._waiting.plugins).forEach(function(e){var t=l.ctx[e];t?c._waiting[e].forEach(function(e){e(t,l)}):console.warn('Waiting for "'+e+'", but does not exist as a plugin?')}),c._waiting={},u.node&&(t.isElement(u.node)||t.isNode(u.node))?f(u.node):f(document.body)}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=webx1.umd.js.map
