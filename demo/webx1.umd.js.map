{"version":3,"file":"webx1.umd.js","sources":["../src/utils/rules.js","../src/index.js"],"sourcesContent":["const rules = {\n    isString: (o) => {\n      return o !== null && typeof o === \"string\";\n    },\n    isEmptyObject: (o) => {\n      var name;\n      for (name in o) {\n        if (o.hasOwnProperty(name)) return false;\n      }\n      return true;\n    },\n    isFunc: (o) => {\n      return typeof o === \"function\";\n    },\n    isAsyncFunc: (fn) => {\n      return rules.isFunc(fn) && fn.constructor.name === \"AsyncFunction\";\n    },\n    isNode: (o) => {\n      return typeof Node === \"object\"\n        ? o instanceof Node\n        : o &&\n            typeof o === \"object\" &&\n            typeof o.nodeType === \"number\" &&\n            typeof o.nodeName === \"string\";\n    },\n    isElement: (o) => {\n      return typeof HTMLElement === \"object\"\n        ? o instanceof HTMLElement //DOM2\n        : o &&\n            typeof o === \"object\" &&\n            o !== null &&\n            o.nodeType === 1 &&\n            typeof o.nodeName === \"string\";\n    },\n  };\n\n  export default rules;","import rules from \"./utils/rules\";\n\nconst defaultOptions = {\n  global: \"$\",\n  appName: \"App\",\n  routes: {},\n};\n\nif (typeof window !== \"undefined\") {\n  window.appRules = rules;\n}\n\nexport default async (options) => {\n  let opts = Object.assign({}, defaultOptions, options);\n\n  let cache = {\n    routes: {\n      \"/\": () => ({\n        view: `<div>Webx Rocks!</div>`,\n      }),\n    },\n  };\n\n  // routes\n  if (!rules.isEmptyObject(opts.routes)) {\n    // prevalidate routes\n    let routeErrors = {};\n    for (var x in opts.routes) {\n      if (opts.routes.hasOwnProperty(x)) {\n        if (!opts.routes[x].view) {\n          routeErrors[x] = [`A view property is required for route \"${x}\"`];\n        }\n      }\n    }\n    if (Object.keys(routeErrors).length) {\n      throw new Error(\"Invalid route configuration\", routeErrors);\n    }\n    cache.routes = opts.routes;\n  }\n\n  const app = {\n    el: document.body,\n    _currentPath: null,\n    _currentRoute: null,\n    _state: {},\n    _listeners: [],\n    routes: { ...cache.routes },\n    ok: true,\n    getState: (...args) => {\n      if (args.length) {\n        return app._state[args[0]];\n      }\n      return ({ ...app._state });\n    },\n    setState: (key, value) => {\n      let oldState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      app._state[key] = value;\n      let newState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      // change listeners\n      app._listeners.forEach((listener) => {\n        listener(\"stateChange\", newState, oldState, key, value);\n      });      \n    },\n    replaceState: (newState) => {\n      let oldState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      app._state = newState;\n      app._listeners.forEach((listener) => {\n        listener(\"stateChange\", newState, oldState, \"*\", newState);\n      });\n    },\n    dispatch: (type, ...args) => {\n      app._listeners.forEach(listener => {\n        listener.apply(null, [type, ...args]);\n      })\n    },\n    listen: (handler) => {\n      if (rules.isFunc(handler)) {\n        app._listeners.push(handler);\n      } else {\n        console.error(\"Listen handler must be a function\", handler);\n      }\n    },\n    refresh: () => {\n      app.navigate(app._currentPath, true);\n    },\n    renderView: async (view, state, meta) => {\n      if (!rules.isFunc(view)) {\n        throw new Error(\"renderView requires a function.\");\n      }\n\n      if (app.el.renderView && rules.isFunc(app.el.renderView)) {\n        if (rules.isAsyncFunc(app.el.renderView)) {\n          try {\n            await app.el.renderView(view, state, meta);\n          } catch (err) {\n            console.error(\"render async view error\", err);\n          }\n        } else {\n          app.el.renderView(view, state, meta);\n        }\n\n        return;\n      }\n\n      if (rules.isAsyncFunc(view)) {\n        try {\n          app.el.innerHTML = await view(state);\n        } catch (err) {\n          console.error(\"Render view errror\", err);\n        }\n      } else {\n        app.el.innerHTML = view(state);\n      }\n\n      if (meta) {\n        document.title = meta.title;\n      }\n    },\n    navigate: async (pathName, force) => {\n      // don't fire same route unless forced\n      if (!force && app._currentPath && app._currentPath === pathName) {\n        return false;\n      }\n      const prevPath = app._currentPath;\n      app._currentPath = pathName;\n      let query = {};\n      let params = {};\n\n      const proxy = {\n        setState: app.setState,\n        getState: app.getState,\n        dispatch: app.dispatch,\n        refresh: app.refresh,\n      };\n\n      const setRoute = async (path, xtra = {}) => {       \n\n        let route = routes[path];        \n\n        if (!route) {\n          route = routes[\"/notfound\"] || {\n            view: () => `<div class=\"page\">404 Not Found</div>`,\n          };\n        }\n\n        app._currentRoute = path;\n\n        query = location.search\n          .slice(1)\n          .split(\"&\")\n          .reduce((prev, curr) => {\n            let t = curr.split(\"=\");\n            prev[t[0]] = decodeURIComponent(t[1] || \"\");\n            return prev;\n          }, {});\n        let state = { ...app.getState(), ...xtra, query, path };\n\n        // Render view\n        try {\n          await app.renderView(route.view, state, route.meta);\n        } catch (err) {\n          console.error(err);\n        }\n\n        // Initialize route\n        if (rules.isFunc(route.init)) {\n          if (rules.isAsyncFunc(route.init)) {\n            await route.init(state, proxy, app.el);\n          } else {\n            route.init(state, proxy, app.el);\n          }\n        }\n\n        const { params = {} } = xtra;\n\n        app._listeners.forEach((listener) => {\n          listener(\"pageChange\", {\n            from: prevPath,\n            to: app._currentRoute,\n            params,\n            query,\n          });\n        });\n      };\n\n      const { routes } = app;\n\n      // Unmount current route, if any\n      if (app._currentRoute) {\n        let route = app.routes[app._currentRoute];\n        if (route && rules.isFunc(route.unmount)) {\n          route.unmount(proxy);\n        }\n      }\n\n      // exact match\n      if (routes[pathName]) {\n        app._currentRoute = pathName;\n        setRoute(pathName);\n        return { path: pathName, route: pathName, query, params };\n      }\n\n      // param route w/fuzzy match logic\n      let tokens = pathName.split(\"/\").slice(1);\n      let found = Object.keys(routes).filter((x) => {\n        return (\n          x.indexOf(`/${tokens[0]}`) !== -1 &&\n          x.split(\"/\").slice(1).length === tokens.length\n        );\n      })[0];\n\n      if (found) {        \n        found\n          .split(\"/\")\n          .slice(2)\n          .forEach((n, x) => {\n            params[n.slice(1)] = tokens[x + 1];\n          });\n        setRoute(found, { params });\n        return { path: pathName, route: found, query, params };\n      }\n      // Not found\n      app._currentRoute = \"notfound\";\n      setRoute(\"/notfound\");\n      return { path: pathName, route: undefined, query, params };\n    },\n  };\n\n  return {\n    mount: async (el) => {\n      try {\n        if (rules.isString(el)) {\n          app.el = document.querySelector(el);\n          if (!app.el) {\n            throw new Error(\n              `Invalid mount target: ${el}. Missing from the DOM.`\n            );\n          }\n        } else {\n          if (!rules.isNode(el) || !rules.isElement(el)) {\n            throw new Error(\"Invalid DOM object for mount.\");\n          }\n          app.el = el;\n        }\n\n        if (rules.isFunc(opts.init)) {\n          opts.debug &&\n            console.log(\n              \"App state from function. Is async: \",\n              rules.isAsyncFunc(opts.init) ? \"yes\" : \"no\"\n            );\n          // try to just invoke function;\n          app._state = rules.isAsyncFunc(opts.init)\n            ? await opts.init()\n            : opts.init();\n        } else {\n          app._state = opts.init || {};\n        }\n\n        if (opts.debug) {\n          console.log(\"Initial app state\", app._state);\n        }\n\n        window.onpopstate = async () => {\n          await app.navigate(window.location.pathname);\n        };\n\n        window[opts.global] = window[opts.global] || {};\n\n        window[opts.global].navigate = async (pathName) => {\n          window.history.pushState(\n            {},\n            pathName,\n            window.location.origin + pathName\n          );\n          await app.navigate(pathName);\n        };\n\n        await app.navigate(window.location.pathname);\n\n        return app;\n      } catch (e) {\n        return { ok: false, error: e };\n      }\n    },\n  };\n};\n"],"names":["rules","isString","o","isEmptyObject","name","hasOwnProperty","isFunc","isAsyncFunc","fn","constructor","isNode","Node","nodeType","nodeName","isElement","HTMLElement","_catch","body","recover","result","e","then","defaultOptions","global","appName","routes","window","appRules","options","opts","Object","assign","cache","/","view","routeErrors","x","keys","length","Error","app","el","document","_currentPath","_currentRoute","_state","_listeners","ok","getState","args","setState","key","value","oldState","freeze","JSON","parse","stringify","newState","forEach","listener","replaceState","dispatch","type","apply","listen","handler","push","console","error","refresh","navigate","renderView","state","meta","title","innerHTML","err","pathName","force","prevPath","query","params","proxy","setRoute","path","xtra","from","to","route","init","location","search","slice","split","reduce","prev","curr","t","decodeURIComponent","unmount","tokens","found","filter","indexOf","n","undefined","mount","debug","log","onpopstate","pathname","history","pushState","origin","querySelector"],"mappings":"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"}