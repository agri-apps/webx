{"version":3,"file":"webx1.umd.js","sources":["../src/utils/rules.js","../src/index.js"],"sourcesContent":["const rules = {\n    isString: (o) => {\n      return o !== null && typeof o === \"string\";\n    },\n    isEmptyObject: (o) => {\n      var name;\n      for (name in o) {\n        if (o.hasOwnProperty(name)) return false;\n      }\n      return true;\n    },\n    isFunc: (o) => {\n      return typeof o === \"function\";\n    },\n    isAsyncFunc: (fn) => {\n      return rules.isFunc(fn) && fn.constructor.name === \"AsyncFunction\";\n    },\n    isNode: (o) => {\n      return typeof Node === \"object\"\n        ? o instanceof Node\n        : o &&\n            typeof o === \"object\" &&\n            typeof o.nodeType === \"number\" &&\n            typeof o.nodeName === \"string\";\n    },\n    isElement: (o) => {\n      return typeof HTMLElement === \"object\"\n        ? o instanceof HTMLElement //DOM2\n        : o &&\n            typeof o === \"object\" &&\n            o !== null &&\n            o.nodeType === 1 &&\n            typeof o.nodeName === \"string\";\n    },\n  };\n\n  export default rules;","import rules from \"./utils/rules\";\n\nconst defaultOptions = {\n  global: \"$\",\n  appName: \"App\",\n  metaTitlePrepend: '',\n  routes: {},\n};\n\nif (typeof window !== \"undefined\") {\n  window.appRules = rules;\n}\n\nexport default async (options) => {\n  let opts = Object.assign({}, defaultOptions, options);\n\n  let cache = {\n    routes: {\n      \"/\": () => ({\n        view: `<div>Webx Rocks!</div>`,\n      }),\n    },\n  };\n\n  // routes\n  if (!rules.isEmptyObject(opts.routes)) {\n    // prevalidate routes\n    let routeErrors = {};\n    for (var x in opts.routes) {\n      if (opts.routes.hasOwnProperty(x)) {\n        if (!opts.routes[x].view) {\n          routeErrors[x] = [`A view property is required for route \"${x}\"`];\n        }\n      }\n    }\n    if (Object.keys(routeErrors).length) {\n      throw new Error(\"Invalid route configuration\", routeErrors);\n    }\n    cache.routes = opts.routes;\n  }\n\n  const getProxy = (app) => {\n    return {\n      setState: app.setState,\n      getState: app.getState,\n      dispatch: app.dispatch,\n      refresh: app.refresh,\n    };\n  } \n\n  const app = {\n    el: document.body,\n    _currentPath: null,\n    _currentRoute: null,\n    _state: {},\n    _listeners: [],\n    _plugins: {},\n    routes: { ...cache.routes },\n    ok: true,\n    getState: (...args) => {\n      if (args.length) {\n        return app._state[args[0]];\n      }\n      return ({ ...app._state });\n    },\n    setState: (key, value) => {\n      let oldState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      app._state[key] = value;\n      let newState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      // change listeners\n      app._listeners.forEach((listener) => {\n        listener(\"stateChange\", newState, oldState, key, value);\n      });      \n    },\n    replaceState: (newState) => {\n      let oldState = Object.freeze(JSON.parse(JSON.stringify(app._state)));\n      app._state = newState;\n      app._listeners.forEach((listener) => {\n        listener(\"stateChange\", newState, oldState, \"*\", newState);\n      });\n    },\n    dispatch: (type, ...args) => {\n      app._listeners.forEach(listener => {\n        listener.apply(null, [type, ...args]);\n      })\n    },\n    listen: (handler) => {\n      if (rules.isFunc(handler)) {\n        app._listeners.push(handler);\n      } else {\n        console.error(\"Listen handler must be a function\", handler);\n      }\n    },\n    refresh: () => {\n      app.navigate(app._currentPath, true);\n    },\n    renderView: async (view, state, meta) => {\n      if (!rules.isFunc(view)) {\n        throw new Error(\"renderView requires a function.\");\n      }\n\n      if (app.el.renderView && rules.isFunc(app.el.renderView)) {\n        if (rules.isAsyncFunc(app.el.renderView)) {\n          try {\n            await app.el.renderView(view, state, meta);\n          } catch (err) {\n            console.error(\"render async view error\", err);\n          }\n        } else {\n          app.el.renderView(view, state, meta);\n        }\n\n        return;\n      }\n\n      if (rules.isAsyncFunc(view)) {\n        try {\n          app.el.innerHTML = await view(state);\n        } catch (err) {\n          console.error(\"Render view errror\", err);\n        }\n      } else {\n        app.el.innerHTML = view(state);\n      }\n\n      if (meta) {\n        document.title = `${opts.metaTitlePrepend}${meta.title}`;\n      }\n    },\n    initRoute: async (route, state) => {\n\n      const proxy = getProxy(app);\n\n      if (rules.isFunc(route.init)) {\n        if (rules.isAsyncFunc(route.init)) {\n          await route.init(state, proxy, app.el);\n        } else {\n          route.init(state, proxy, app.el);\n        }\n      }\n    },\n    unmountRoute: (route) => {\n      if (route && rules.isFunc(route.unmount)) {\n        route.unmount(getProxy(app));\n      }\n    },\n    navigate: async (pathName, force) => {\n      // don't fire same route unless forced\n      if (!force && app._currentPath && app._currentPath === pathName) {\n        return false;\n      }\n      const prevPath = app._currentPath;\n      app._currentPath = pathName;\n      let query = {};\n      let params = {};\n\n      const setRoute = async (path, xtra = {}) => {       \n\n        let route = routes[path];        \n\n        if (!route) {\n          route = routes[\"/notfound\"] || {\n            view: () => `<div class=\"page\">404 Not Found</div>`,\n          };\n        }\n\n        app._currentRoute = path;\n\n        query = location.search\n          .slice(1)\n          .split(\"&\")\n          .reduce((prev, curr) => {\n            let t = curr.split(\"=\");\n            prev[t[0]] = decodeURIComponent(t[1] || \"\");\n            return prev;\n          }, {});\n        let state = { ...app.getState(), ...xtra, query, path };\n\n        // Render view\n        try {\n          await app.renderView(route.view, state, route.meta);\n        } catch (err) {\n          console.error(err);\n        }\n\n        // Initialize route\n        await app.initRoute(route, state);\n\n        const { params = {} } = xtra;\n\n        app._listeners.forEach((listener) => {\n          listener(\"pageChange\", {\n            from: prevPath,\n            to: app._currentRoute,\n            params,\n            query,\n          });\n        });\n      };\n\n      const { routes } = app;\n\n      // Unmount current route, if any\n      if (app._currentRoute) {\n        app.unmountRoute(app.routes[app._currentRoute]);        \n      }\n\n      // exact match\n      if (routes[pathName]) {\n        app._currentRoute = pathName;\n        setRoute(pathName);\n        return { path: pathName, route: pathName, query, params };\n      }\n\n      // param route w/fuzzy match logic\n      let tokens = pathName.split(\"/\").slice(1);\n      let found = Object.keys(routes).filter((x) => {\n        return (\n          x.indexOf(`/${tokens[0]}`) !== -1 &&\n          x.split(\"/\").slice(1).length === tokens.length\n        );\n      })[0];\n\n      if (found) {        \n        found\n          .split(\"/\")\n          .slice(2)\n          .forEach((n, x) => {\n            params[n.slice(1)] = tokens[x + 1];\n          });\n        setRoute(found, { params });\n        return { path: pathName, route: found, query, params };\n      }\n      // Not found\n      app._currentRoute = \"notfound\";\n      setRoute(\"/notfound\");\n      return { path: pathName, route: undefined, query, params };\n    },\n    boot: async () => {\n      // intended to be monkey patched in plugins.\n    }\n  };\n\n  const proxy = {\n    use: (plugin, options = {}) => {\n      if (!plugin.name) {\n        throw new Error('A plugin must have a name property.');\n      }\n      if (!plugin.install || !rules.isFunc(plugin.install)) {\n        throw new Error('A plugin must define an install method.');\n      }\n      if (app._plugins[plugin.name]) {\n        throw new Error(`A plugin with the name: \"${plugin.name} is already registered.\"`);\n      }\n      app._plugins[plugin.name] = plugin;\n      try {\n        plugin.install(app, options);\n      } catch (err) {\n        console.error(`Plugin \"${plugin.name}\" failed to install.`, err);\n        delete app._plugins[plugin.name];\n      }\n\n      return proxy;\n    },\n    mount: async (el) => {\n      try {\n        if (rules.isString(el)) {\n          app.el = document.querySelector(el);\n          if (!app.el) {\n            throw new Error(\n              `Invalid mount target: ${el}. Missing from the DOM.`\n            );\n          }\n        } else {\n          if (!rules.isNode(el) || !rules.isElement(el)) {\n            throw new Error(\"Invalid DOM object for mount.\");\n          }\n          app.el = el;\n        }\n\n        if (rules.isFunc(opts.init)) {\n          opts.debug &&\n            console.log(\n              \"App state from function. Is async: \",\n              rules.isAsyncFunc(opts.init) ? \"yes\" : \"no\"\n            );\n          // try to just invoke function;\n          app._state = rules.isAsyncFunc(opts.init)\n            ? await opts.init()\n            : opts.init();\n        } else {\n          app._state = opts.init || {};\n        }\n\n        if (opts.debug) {\n          console.log(\"Initial app state\", app._state);\n        }\n\n        window.onpopstate = async () => {\n          await app.navigate(window.location.pathname);\n        };\n\n        window[opts.global] = window[opts.global] || {};\n\n        window[opts.global].navigate = async (pathName) => {\n          window.history.pushState(\n            {},\n            pathName,\n            window.location.origin + pathName\n          );\n          await app.navigate(pathName);\n        };\n\n        window[opts.global].dispatch = app.dispatch.bind(app);\n\n        await app.navigate(window.location.pathname);\n\n        await app.boot();\n\n        return app;\n      } catch (e) {\n        return { ok: false, error: e };\n      }\n    },\n  };\n\n  return proxy;\n};\n"],"names":["rules","isString","o","isEmptyObject","name","hasOwnProperty","isFunc","isAsyncFunc","fn","constructor","isNode","Node","nodeType","nodeName","isElement","HTMLElement","_catch","body","recover","result","e","then","defaultOptions","global","appName","metaTitlePrepend","routes","window","appRules","options","opts","Object","assign","cache","/","view","routeErrors","x","keys","length","Error","getProxy","app","setState","getState","dispatch","refresh","el","document","_currentPath","_currentRoute","_state","_listeners","_plugins","ok","args","key","value","oldState","freeze","JSON","parse","stringify","newState","forEach","listener","replaceState","type","apply","listen","handler","push","console","error","navigate","renderView","state","meta","title","innerHTML","err","initRoute","route","proxy","init","unmountRoute","unmount","pathName","force","prevPath","query","params","setRoute","path","xtra","from","to","location","search","slice","split","reduce","prev","curr","t","decodeURIComponent","tokens","found","filter","indexOf","n","undefined","boot","use","plugin","install","mount","debug","log","onpopstate","pathname","history","pushState","origin","bind","querySelector"],"mappings":"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"}